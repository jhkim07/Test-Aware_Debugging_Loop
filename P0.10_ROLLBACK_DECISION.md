# P0.10 Rollback Decision Report

**Date**: 2025-12-25  
**Decision**: **ROLLBACK TO P0.9 RECOMMENDED**

## Executive Summary

P0.10 was designed to solve astropy-14365 file I/O issues and astropy-14182 RST malformed patches through prompt enhancement. While it successfully solved astropy-14365, it introduced **systematic BRS regression** in 2 previously passing cases and failed to solve astropy-14182.

**Net Result**: P0.10 is worse than P0.9 on the full benchmark.

---

## Test Results Comparison

### P0.9 Baseline (Best Previous Version)
| Instance | HFS | TSS | BRS | Overall | Status |
|----------|-----|-----|-----|---------|--------|
| astropy-12907 | 100% | 100% | **100%** | 99.38% | ✅ Perfect |
| sympy-20590 | 100% | 100% | **100%** | 99.38% | ✅ Perfect |
| astropy-14182 | 100% | 100% | 100% | 99.38% | ✅ Perfect |
| astropy-14365 | 0% | 0% | 0% | 0% | ❌ Failed |

**P0.9 Summary**: 3/4 passing (75%), Average Overall Score: **74.53%**

---

### P0.10 Full Regression Test
| Instance | HFS | TSS | BRS | Overall | Status |
|----------|-----|-----|-----|---------|--------|
| astropy-12907 | 100% | 50% | **0%** | 84.17% | ⚠️ **BRS Regressed** |
| sympy-20590 | 100% | 50% | **0%** | 84.17% | ⚠️ **BRS Regressed** |
| astropy-14182 | 0% | 100% | N/A | 2.08% | ❌ Still failing |
| astropy-14365 | **100%** | 100% | 100% | 99.38% | ✅ **Fixed!** |

**P0.10 Summary**: 3/4 passing (75%), Average Overall Score: **67.45%**

---

### P0.10 Multiple Runs (Consistency Test)
**Instance**: astropy-12907 (gpt-4o-mini)  
**Results**: 5 runs, identical configuration
```
Run 1: BRS = 0.0
Run 2: BRS = 0.0
Run 3: BRS = 0.0
Run 4: BRS = 0.0
Run 5: BRS = 0.0

Mean: 0.0%
Std Dev: 0.0%
Consistency: 100% (systematic failure, NOT random)
```

---

### P0.10 GPT-4 Test
**Instance**: astropy-12907, sympy-20590 (GPT-4 upgrade)  
**Results**:
- astropy-12907: BRS = **0%** (no recovery)
- sympy-20590: BRS = **100%** (recovered!)

**Conclusion**: BRS regression is partially model-dependent, but astropy-12907 fails even with GPT-4.

---

## Score Comparison

| Metric | P0.9 | P0.10 | Change | Verdict |
|--------|------|-------|--------|---------|
| **Success Rate** | 75% (3/4) | 75% (3/4) | **0%** | Neutral |
| **Average Overall** | **74.53%** | 67.45% | **-7.08%p** | ❌ Worse |
| **BRS Score** | 100% (3/3) | 50% (1/2) | **-50%p** | ❌ Worse |
| **Perfect Scores** | 3 | 1 | **-2** | ❌ Worse |

---

## Root Cause Analysis

### What Went Wrong?

1. **astropy-12907 & sympy-20590 BRS Regression**
   - **P0.9**: Both had perfect BRS (100%)
   - **P0.10**: Both consistently fail BRS (0%)
   - **Issue**: Tests now pass on buggy code (no longer reproducing the bug)
   
2. **Not LLM Non-determinism**
   - Multiple runs test shows **100% consistency** (all 5 runs = 0%)
   - This is **systematic**, not random variance
   
3. **Prompt Enhancement Side Effects**
   - Added 87 lines of RST/File I/O guidance
   - Hypothesis: Diluted prompt focus, changed LLM behavior
   - **Evidence**: Rollback test (removed CRITICAL REMINDERS) still showed BRS = 0%
   - **Conclusion**: The added system prompt rules in [prompts.py:148-235](bench_agent/agent/prompts.py#L148-L235) are causing the regression

4. **astropy-14182 Still Failing**
   - All 3 iterations failed with malformed patches
   - RST separator guidance had no effect
   - Conclusion: Prompt alone is insufficient, needs Phase 2 (Enhanced Normalization)

---

## What Worked in P0.10?

✅ **astropy-14365**: Fixed perfectly (0% → 99.38%)
- File I/O policy modification worked
- CRITICAL REMINDERS guided LLM to use `tmp_path`
- This was the ONLY success

---

## Rollback Strategy

### Recommended: Full Rollback to P0.9

**Revert the following changes**:

1. **[bench_agent/agent/prompts.py](bench_agent/agent/prompts.py)**
   - Remove lines 148-235 (RST diff format rules and File I/O alternatives)
   - Restore original P0.9 prompts

2. **[bench_agent/protocol/policy.py](bench_agent/protocol/policy.py)**
   - Remove lines 41-56 (tmp_path allowance)
   - Restore strict file I/O blocking

3. **[bench_agent/agent/test_author.py](bench_agent/agent/test_author.py)**
   - Keep as-is (CRITICAL REMINDERS already removed in rollback test)

**Impact**:
- Recover astropy-12907 and sympy-20590 BRS (100%)
- Lose astropy-14365 (back to 0%)
- Net: 3/4 passing, 74.53% average (vs P0.10: 67.45%)
- **Gain**: +7.08% overall score

---

## Alternative: Partial Rollback (Not Recommended)

Keep policy.py changes for astropy-14365, but revert prompts.py.

**Risk**: Still uncertain if policy change alone affects BRS.  
**Better**: Full rollback first, then re-test astropy-14365 fix in isolation.

---

## Lessons Learned

1. **Prompt bloat is harmful**: Adding 87 lines diluted focus and broke working cases
2. **Test smaller changes**: P0.10 changed too much at once (prompts + policy + user messages)
3. **Regression testing is critical**: Always run full benchmark before declaring success
4. **Phase 2 needed for RST**: Prompt guidance alone cannot fix astropy-14182

---

## Next Steps After Rollback

1. **Execute full rollback**:
   ```bash
   git diff HEAD bench_agent/agent/prompts.py bench_agent/protocol/policy.py
   # Manually revert or use git checkout
   ```

2. **Verify P0.9 recovery**:
   ```bash
   python scripts/run_mvp.py --config configs/p09_regression.yaml --run-id p0.9-recovery-test
   ```

3. **Re-approach astropy-14365** (separately):
   - Minimal prompt addition (2-3 lines max)
   - Test ONLY astropy-14365 first
   - Then run full regression

4. **Implement Phase 2 for astropy-14182**:
   - Enhanced normalization in pre-processing
   - Regex-based RST separator quoting
   - Skip prompt-based solutions

---

## Conclusion

**P0.10 made things worse overall** despite fixing 1 new case:
- Lost 2 previously perfect cases (BRS regression)
- Failed to fix astropy-14182
- Net score decrease: -7.08%

**Recommendation**: **ROLLBACK TO P0.9 IMMEDIATELY**

User requested:
> "만약 여전히 이전 최고 점수보다 좋지 않다면 이전으로 roleback"

**Verdict**: P0.10 (67.45%) < P0.9 (74.53%) → **ROLLBACK REQUIRED**
