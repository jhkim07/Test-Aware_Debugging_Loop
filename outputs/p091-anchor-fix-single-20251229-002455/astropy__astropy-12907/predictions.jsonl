{"instance_id": "astropy__astropy-12907", "model_patch": "--- a/astropy/modeling/tests/test_separable.py\n+++ b/astropy/modeling/tests/test_separable.py\n@@ -56,6 +56,19 @@\n }\n\n+def test_separability_matrix_for_nested_compound_models():\n+    cm = models.Linear1D(10) & models.Linear1D(5)\n+    expected_matrix_cm = np.array([[True, False], [False, True]])\n+    assert_allclose(separability_matrix(cm), expected_matrix_cm)\n+\n+    nested_cm = models.Pix2Sky_TAN() & cm\n+    expected_matrix_nested_cm = np.array([\n+        [True, True, False, False],\n+        [True, True, False, False],\n+        [False, False, True, True],\n+        [False, False, True, True]\n+    ])\n+    assert_allclose(separability_matrix(nested_cm), expected_matrix_nested_cm)\n def test_coord_matrix():\n     c = _coord_matrix(p2, 'left', 2)\n     assert_allclose(np.array([[1, 1], [0, 0]]), c)\n\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -217,6 +217,20 @@\n def _cstack(left, right):\n+    noutp = _compute_n_outputs(left, right)\n+\n+    if isinstance(left, Model):\n+        cleft = _coord_matrix(left, 'left', noutp)\n+    else:\n+        cleft = np.zeros((noutp, left.shape[1]))\n+        cleft[: left.shape[0], : left.shape[1]] = left\n+    if isinstance(right, Model):\n+        cright = _coord_matrix(right, 'right', noutp)\n+    else:\n+        cright = np.zeros((noutp, right.shape[1]))\n+        cright[-right.shape[0]:, -right.shape[1]:] = right\n+\n+    return np.hstack([cleft, cright])\n     \"\"\"\n     Function corresponding to '&' operation.\n", "model_name_or_path": "test-aware-debugging"}
